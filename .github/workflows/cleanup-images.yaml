name: Cleanup Old Container Images

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (true/false)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    env:
      CLEANUP_DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run || 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Determine cleanup candidates
        id: versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/cleanup-container-images.sh \
            --retention-days 90 \
            --min-versions 3 \
            --dry-run "${{ env.CLEANUP_DRY_RUN }}" \
            --github-output "$GITHUB_OUTPUT"

      - name: Delete old package versions
        uses: actions/delete-package-versions@v5
        if: steps.versions.outputs.delete_versions != '' && env.CLEANUP_DRY_RUN != 'true'
        with:
          package-name: 'fedora-zfs-kmods'
          package-type: 'container'
          package-version-ids: ${{ steps.versions.outputs.delete_versions }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Dry run summary
        if: env.CLEANUP_DRY_RUN == 'true'
        run: |
          echo "ðŸ§ª DRY RUN COMPLETE"
          echo "This was a dry run - no versions were actually deleted."
          echo ""
          if [[ -n "${{ steps.versions.outputs.delete_versions }}" ]]; then
            echo "ðŸ“‹ Deletion candidates found:"
            echo "${{ steps.versions.outputs.delete_versions }}" | tr ',' '\n' | nl -w2 -s'. ID: '
            echo ""
            echo "To perform actual cleanup, run this workflow with dry_run=false"
          else
            echo "âœ… No versions were eligible for deletion"
            echo "All versions are either:"
            echo "  - Within the 90-day retention window"
            echo "  - One of the 3 most recent versioned tags"  
            echo "  - Attestations for protected images"
          fi
          echo ""
          echo "ðŸ”’ Safety mechanisms active:"
          echo "  - Minimum 3 versioned tags protected"
          echo "  - Attestations preserved for all retained images"
          echo "  - 90-day retention window enforced"
      
      - name: Cleanup completion summary
        if: env.CLEANUP_DRY_RUN != 'true' && steps.versions.outputs.delete_versions != ''
        run: |
          echo "âœ… CLEANUP COMPLETED"
          echo "Successfully deleted older container versions while preserving:"
          echo "  - 3 most recent versioned tags"
          echo "  - All corresponding attestations"
          echo "  - All versions within 90-day window"